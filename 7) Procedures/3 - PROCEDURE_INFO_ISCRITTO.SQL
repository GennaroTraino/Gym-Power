CREATE OR REPLACE PROCEDURE INFO_ISCRITTO
(
	CF_I            ISCRITTO.CF_ISCRITTO%TYPE
)
IS

USER 				ISCRITTO%ROWTYPE;
BADGE_IN 			ABBONAMENTO.BADGE%TYPE;
DATA_IN 	 		ABBONAMENTO.DATA_INIZIO%TYPE;
DATA_FN 			ABBONAMENTO.DATA_SCADENZA%TYPE;
LIVELLO_IN 			SCHEDA_ESERCIZI.LIVELLO%TYPE;
CORSI 			 	PREVEDE%ROWTYPE;
LISTA 				CONTIENE%ROWTYPE;
NO_SCHEDA  			EXCEPTION;
CURSOR CORSI_SCHEDA IS
	-- MOSTRA I CORSI A CUI Ã¨ ISCRITTO L'UTENTE
	SELECT BADGE_FK,CAP_CORSO_FK,NOME_CORSO_FK
	FROM ISCRITTO JOIN ABBONAMENTO  ON CF_ISCRITTO = CF_ISCRITTO_ABBONAMENTO
		JOIN PREVEDE ON BADGE_FK = BADGE
	WHERE CF_ISCRITTO = CF_I;

CURSOR LISTA_ES IS
	-- LA LISTA DI ESERCIZI NELLA SCHEDA
	SELECT E.N_SCHEDA_FK,C.NOME_ESERCIZIO,C.N_SERIE,C.N_RIPETIZIONI
	FROM SCHEDA_ESERCIZI S JOIN CONTIENE C ON S.N_SCHEDA = C.N_SCHEDA_FK
		JOIN E_ASSEGNATA E ON E.N_SCHEDA_FK = C.N_SCHEDA_FK
	WHERE CF_ISCRITTO_FK = CF_I;



BEGIN

SELECT CF_ISCRITTO,TELEFONO,NOME,COGNOME,SESSO,DATA_NASCITA INTO USER
FROM ISCRITTO 
WHERE CF_ISCRITTO = CF_I;

-- MOSTRA INFORMAZIONI BASE DELL'ISCRITTO
DBMS_OUTPUT.PUT_LINE('NOME: ' 		|| USER.NOME);
DBMS_OUTPUT.PUT_LINE('COGNOME: ' 	|| USER.COGNOME);
DBMS_OUTPUT.PUT_LINE('SESSO: '		|| USER.SESSO);
DBMS_OUTPUT.PUT_LINE('TELEFONO: '	|| USER.TELEFONO);

-- INFORMAZIONI SU ABBONAMENTO
SELECT BADGE, DATA_INIZIO, DATA_SCADENZA INTO BADGE_IN,DATA_IN,DATA_FN
FROM ISCRITTO JOIN ABBONAMENTO  ON CF_ISCRITTO = CF_ISCRITTO_ABBONAMENTO
WHERE CF_ISCRITTO = CF_I;

DBMS_OUTPUT.PUT_LINE('BADGE ABBONAMENTO: ' 		|| BADGE_IN);
DBMS_OUTPUT.PUT_LINE('DATA INIZIO: ' 			|| DATA_IN);
DBMS_OUTPUT.PUT_LINE('DATA SCADENZA: '			|| DATA_FN);
DBMS_OUTPUT.PUT_LINE('DURATA RIMANENTE: ' 		|| TRUNC(TO_NUMBER(DATA_FN-SYSDATE)) || ' GIORNI');


OPEN CORSI_SCHEDA;

IF CORSI_SCHEDA%NOTFOUND THEN
	CLOSE CORSI_SCHEDA;
END IF;

LOOP
	FETCH CORSI_SCHEDA INTO CORSI;
	EXIT WHEN CORSI_SCHEDA%NOTFOUND;
	DBMS_OUTPUT.PUT_LINE('CORSO: ' || CORSI.NOME_CORSO_FK || CORSI.CAP_CORSO_FK);
END LOOP;
CLOSE CORSI_SCHEDA;

SELECT LIVELLO INTO LIVELLO_IN
FROM ISCRITTO JOIN E_ASSEGNATA ON CF_ISCRITTO = CF_ISCRITTO_FK
	JOIN SCHEDA_ESERCIZI ON N_SCHEDA = N_SCHEDA_FK
WHERE CF_ISCRITTO = CF_I;
DBMS_OUTPUT.PUT_LINE('DETTAGLIO SCHEDA ALLENAMENTO');
DBMS_OUTPUT.PUT_LINE('LIVELLO SCHEDA: '			|| LIVELLO_IN);
DBMS_OUTPUT.PUT_LINE('ESERCIZI: ');


-- MOSTRA SCHEDA UTENTE CON ESERCIZI
OPEN LISTA_ES;

IF LISTA_ES%NOTFOUND THEN
	RAISE NO_SCHEDA;
	CLOSE LISTA_ES;
END IF;

LOOP
	FETCH LISTA_ES INTO LISTA;
	EXIT WHEN LISTA_ES%NOTFOUND;
	DBMS_OUTPUT.PUT_LINE(' ');
	DBMS_OUTPUT.PUT_LINE('NOME: ' || LISTA.NOME_ESERCIZIO || 'SERIE: ' || LISTA.N_SERIE || ' x ' || LISTA.N_RIPETIZIONI); 
END LOOP;
CLOSE LISTA_ES;




EXCEPTION
WHEN NO_DATA_FOUND THEN
	RAISE_APPLICATION_ERROR(-20543,'ISCRITTO NON ESISTENTE');
WHEN NO_SCHEDA THEN
	DBMS_OUTPUT.PUT_LINE('L ISCRITTO NON POSSIEDE UNA SCHEDA ESERCIZI');

END INFO_ISCRITTO;
/